<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Navigo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
    <link rel="stylesheet" href="style.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-rotatedmarker/leaflet.rotatedMarker.js"></script>
    <!-- Include Leaflet-Rotate plugin's JS file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-rotatedmarker/0.2.0/leaflet.rotatedMarker.min.js"></script>
    <style>
        #map-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
            transition: transform 0.5s;
        }
    </style>
</head>
<body>
<main>
    <button class="settings-toggle-button" onclick="toggleSettings()">
        <i class="fas fa-cog" style="color: var(--icon-color);"></i>
    </button>
    <section class="hero">
        <h2 class="heading">Welcome to Navigo</h2>
        <p class="subheading">Navigation done right</p>
        <button class="button get-started-button" onclick="showDestinationSection()">
            <i class="fas fa-car-side"></i> <span>GO!</span>
        </button>
    </section>
    <section id="destination-section" class="destination-section">
        <h2 class="heading">Plan Your Ride</h2>
        <form onsubmit="event.preventDefault(); goBtn();">
            <div class="input-container">
                <div class="input-wrapper">
                    <input type="text" id="destination" name="destination" list="destination-list" placeholder="Destination" oninput="getLocationSuggestions(event, 'dest')">
                    <datalist id="destination-list"></datalist>
                </div>
            </div>
            <button type="submit" class="button btn request-button"><i class="fas fa-car-side"></i> <span>GO!</span></button>
        </form>
    </section>
    <div id="map-container">
        <div id="map"></div>
    </div>
    <div id="unavailable-message" class="destination-section">
        <h2 class="heading">NAVIGO is unavailable outside of Europe</h2>
    </div>

    <!-- Settings Overlay -->
    <div class="settings-overlay" id="settings-overlay">
        <div class="settings-container">
            <button class="close-settings" onclick="closeSettings()">
                <i class="fas fa-times"></i>
            </button>
            <h2>Settings</h2>
            <div class="form-group">
                <label for="api-key-input">API Key</label>
                <input type="text" id="api-key-input" placeholder="Enter your API Key">
            </div>
            <div class="form-group dark-mode-toggle">
                <label for="theme-toggle">Theme</label>
                <button id="theme-toggle" onclick="toggleTheme()">
                    <i class="fas" id="settings-theme-icon"></i>
                </button>
            </div>
            <div class="credits">
                <h3>Credits</h3>
                <p>Icons by <a href="https://fontawesome.com/" target="_blank">FontAwesome</a></p>
                <p>Maps by <a href="https://leafletjs.com/" target="_blank">Leaflet</a></p>
                <p>Routing by <a href="https://www.liedman.net/leaflet-routing-machine/" target="_blank">Leaflet Routing Machine</a></p>
            </div>
        </div>
    </div>
</main>

<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>
<script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
<script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
<script>
let API_KEY = localStorage.getItem('api_key') || '';
let startMarker, destMarker, routeControl;
let map;
let userLocation = null;

if (!API_KEY) {
    promptForApiKey();
}

function promptForApiKey() {
    let apiKey;
    do {
        apiKey = prompt('Please enter your HERE API key:');
    } while (!apiKey);
    localStorage.setItem('api_key', apiKey);
    API_KEY = apiKey;
}

function toggleSettings() {
    const settingsOverlay = document.getElementById('settings-overlay');
    if (settingsOverlay.style.display === 'flex') {
        settingsOverlay.style.display = 'none';
    } else {
        settingsOverlay.style.display = 'flex';
        document.getElementById('api-key-input').value = API_KEY || '';
        updateSettingsThemeIcon();
    }
}

function closeSettings() {
    const settingsOverlay = document.getElementById('settings-overlay');
    const newApiKey = document.getElementById('api-key-input').value;
    if (newApiKey) {
        localStorage.setItem('api_key', newApiKey);
        API_KEY = newApiKey;
    }
    settingsOverlay.style.display = 'none';
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute("data-theme");
    const newTheme = currentTheme === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", newTheme);
    localStorage.setItem('theme', newTheme); // Save the theme to localStorage
    updateThemeIcon();
    updateSettingsThemeIcon();
}

function updateThemeIcon() {
    const currentTheme = document.documentElement.getAttribute("data-theme");
    const themeIcon = document.getElementById("theme-toggle").querySelector('i');
    if (currentTheme === "dark") {
        themeIcon.classList.remove("fa-sun");
        themeIcon.classList.add("fa-moon");
    } else {
        themeIcon.classList.remove("fa-moon");
        themeIcon.classList.add("fa-sun");
    }
}

function updateSettingsThemeIcon() {
    const currentTheme = document.documentElement.getAttribute("data-theme");
    const settingsThemeIcon = document.getElementById("settings-theme-icon");
    if (currentTheme === "dark") {
        settingsThemeIcon.classList.remove("fa-sun");
        settingsThemeIcon.classList.add("fa-moon");
    } else {
        settingsThemeIcon.classList.remove("fa-moon");
        settingsThemeIcon.classList.add("fa-sun");
    }
}

function showDestinationSection() {
    const button = document.querySelector('.get-started-button');
    const icon = button.querySelector('.fas');
    const text = button.querySelector('span');
    const heroText = document.querySelectorAll('.hero h2, .hero p');
    const heroSection = document.querySelector('.hero');
    const destinationSection = document.getElementById('destination-section');

    button.classList.add('driving');
    text.classList.add('disappear');
    heroText.forEach(element => element.classList.add('hidden'));

    icon.addEventListener('animationend', () => {
        heroSection.classList.add('hidden');
        destinationSection.style.display = 'block';
        destinationSection.classList.add('visible');
        destinationSection.scrollIntoView({ behavior: 'smooth' });
    });
}

function goBtn() {
    const rqbutton = document.querySelector('.request-button');
    const rqicon = rqbutton.querySelector('.fas');
    const rqtext = rqbutton.querySelector('span');
    const destinationText = document.querySelectorAll('.destination-section h2, .destination-section div');
    const destinationSection = document.getElementById('destination-section');

    const destination = document.getElementById('destination').value;
    if (!destination) {
        alert('Please enter a destination.');
        return;
    }

    rqbutton.classList.add('driving');
    rqtext.classList.add('disappear');
    destinationText.forEach(element => element.classList.add('hidden'));

    rqicon.addEventListener('animationend', () => {
        destinationSection.classList.add('hidden');
    });

    if (userLocation) {
        addMarkersAndFetchRoute(userLocation);
    }
}

function showMapOrMessage(latitude, longitude, _map) {
    const mapContainer = document.getElementById('map-container');
    const message = document.getElementById('unavailable-message');

    if (isLocationInEurope(latitude, longitude)) {
        mapContainer.style.display = 'block';
        message.style.display = 'none';
        _map.setView([latitude, longitude], 16);  // Zoom in closer when location is detected
    } else {
        mapContainer.style.display = 'none';
        message.style.display = 'block';
    }
}

function isLocationInEurope(lat, lon) {
    return lat >= 34.0 && lat <= 72.0 && lon >= -25.0 && lon <= 45.0;
}

function getLocationSuggestions(event, type) {
    const query = event.target.value;
    const dataList = document.getElementById(`${type === 'start' ? 'start-point-list' : 'destination-list'}`);

    if (query === '') {
        dataList.innerHTML = '';
        return;
    }

    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=5&bounded=1&viewbox=-25.0,72.0,45.0,34.0`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            dataList.innerHTML = '';
            data.forEach(place => {
                const option = document.createElement('option');
                option.value = place.display_name;
                dataList.appendChild(option);
            });
        });
}

function addMarkersAndFetchRoute(startLatLng) {
    const destination = document.getElementById('destination').value;

    if (!destination) {
        alert('Please enter a destination.');
        return;
    }

    const destGeocodeUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(destination)}&format=json&addressdetails=1&limit=1`;

    fetch(destGeocodeUrl)
        .then(response => response.json())
        .then(destData => {
            if (destData.length > 0) {
                const destLatLng = [destData[0].lat, destData[0].lon];

                const startIcon = L.icon({
                    iconUrl: 'img/start-icon.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                });

                const destIcon = L.icon({
                    iconUrl: 'img/destination-icon.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                });

                if (startMarker) {
                    map.removeLayer(startMarker);
                }
                if (destMarker) {
                    map.removeLayer(destMarker);
                }
                if (routeControl) {
                    map.removeControl(routeControl);
                }

                startMarker = L.marker(startLatLng, { icon: startIcon }).addTo(map).bindPopup('Start Point').openPopup();
                destMarker = L.marker(destLatLng, { icon: destIcon }).addTo(map).bindPopup('Destination').openPopup();

                fetchRouteWithTraffic(startLatLng, destLatLng);
            } else {
                alert('Unable to geocode the destination.');
            }
        });
}

function calculateBearing(start, end) {
    const startLat = start[0] * Math.PI / 180;
    const startLng = start[1] * Math.PI / 180;
    const endLat = end[0] * Math.PI / 180;
    const endLng = end[1] * Math.PI / 180;

    const dLng = endLng - startLng;
    const y = Math.sin(dLng) * Math.cos(endLat);
    const x = Math.cos(startLat) * Math.sin(endLat) - Math.sin(startLat) * Math.cos(endLat) * Math.cos(dLng);
    let bearing = Math.atan2(y, x) * 180 / Math.PI;

    return (bearing + 360) % 360;
}

async function fetchRouteWithTraffic(startLatLng, destLatLng) {
    try {
        const response = await fetch(`https://router.hereapi.com/v8/routes?transportMode=car&origin=${startLatLng[0]},${startLatLng[1]}&destination=${destLatLng[0]},${destLatLng[1]}&return=polyline,summary,travelSummary&apikey=${API_KEY}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`Error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Route Data:', data);

        if (data.routes && data.routes.length > 0) {
            const route = data.routes[0];
            if (route.sections && route.sections.length > 0) {
                const section = route.sections[0];

                // Using HERE API polyline decoder
                const decodedLine = H.geo.LineString.fromFlexiblePolyline(section.polyline);
                const coords = [];
                decodedLine.eachLatLngAlt((lat, lng, alt) => {
                    coords.push([lat, lng]);
                });

                console.log('Route coordinates:', coords);

                // Rotate map based on the direction of the first segment
                if (coords.length > 1) {
                    const bearing = calculateBearing(coords[0], coords[1]);
                    rotateMap(bearing);
                }

                routeControl = L.Routing.control({
                    waypoints: [
                        L.latLng(startLatLng),
                        L.latLng(destLatLng)
                    ],
                    createMarker: function (i, waypoint, n) {
                        const iconUrl = i === 0 ? 'img/start-icon.png' : 'img/destination-icon.png';
                        return L.marker(waypoint.latLng, {
                            icon: L.icon({
                                iconUrl: iconUrl,
                                iconSize: [32, 32],
                                iconAnchor: [16, 32],
                                popupAnchor: [0, -32]
                            }),
                            rotationAngle: i === 0 ? calculateBearing(coords[0], coords[1]) : 0
                        });
                    },
                    lineOptions: {
                        styles: [{ color: 'blue', opacity: 0.6, weight: 4 }]
                    },
                    routeWhileDragging: false,
                    show: false,
                    addWaypoints: false
                }).addTo(map);
            } else {
                throw new Error('Route polyline data is missing.');
            }
        } else {
            throw new Error('No valid route found or route data is missing.');
        }
    } catch (error) {
        console.error('Error fetching route:', error.message);
        alert(`Error fetching route: ${error.message}`);
    }
}

function rotateMap(bearing) {
    document.getElementById('map').style.transform = `rotate(${bearing}deg)`;
}

document.addEventListener('DOMContentLoaded', function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        document.documentElement.setAttribute("data-theme", savedTheme);
    }
    updateThemeIcon();
    updateSettingsThemeIcon();

    map = L.map('map', {
        center: [54.5260, 15.2551],
        zoom: 16,  // Closer zoom level
        zoomControl: false,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        dragging: true,
        attributionControl: false,
        maxBounds: [[34.0, -25.0], [72.0, 45.0]],
        maxBoundsViscosity: 1.0
    });

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        minZoom: 4,
        maxZoom: 19
    }).addTo(map);

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            function(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                console.log(`Latitude: ${latitude}, Longitude: ${longitude}`);
                userLocation = [latitude, longitude];
                showMapOrMessage(latitude, longitude, map);
                if (!startMarker) {
                    map.setView(userLocation, 16);  // Set view to closer zoom level when location is updated
                }
            },
            function(error) {
                console.error(`Error obtaining location: ${error.message}`);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    } else {
        console.error('Geolocation is not supported by this browser.');
    }
});
</script>
</body>
</html>